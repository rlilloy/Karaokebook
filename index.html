#!/usr/bin/env python3
"""
Script para dividir un documento Word con m√∫ltiples cuentos en archivos separados.
Cada cuento est√° identificado por un T√≠tulo 3 (Heading 3).

Uso:
1. Coloc√° el archivo mf.docx en la misma carpeta que este script
2. Ejecut√°: python dividir_cuentos.py
3. Se crean archivos separados en la carpeta 'cuentos_separados/'
"""

import os
from pathlib import Path

try:
    from docx import Document
    from docx.enum.style import WD_STYLE_TYPE
except ImportError:
    print("‚ùå Error: Necesit√°s instalar python-docx")
    print("Ejecut√°: pip install python-docx")
    exit(1)


def dividir_cuentos_por_heading3(archivo_entrada, carpeta_salida='cuentos_separados'):
    """
    Divide un documento con m√∫ltiples cuentos en archivos separados.
    Usa Heading 3 como separador entre cuentos.
    """
    
    # Crear carpeta de salida
    Path(carpeta_salida).mkdir(exist_ok=True)
    
    print(f"üìñ Leyendo archivo: {archivo_entrada}")
    doc = Document(archivo_entrada)
    
    cuentos = []
    cuento_actual = {
        'titulo': None,
        'contenido': []
    }
    
    # Procesar cada p√°rrafo del documento
    for para in doc.paragraphs:
        # Detectar si es un Heading 3 (t√≠tulo de cuento)
        if para.style.name == 'Heading 3' or 'Heading 3' in para.style.name:
            # Si ya hay un cuento en proceso, guardarlo
            if cuento_actual['titulo'] is not None:
                cuentos.append(cuento_actual)
            
            # Iniciar nuevo cuento
            cuento_actual = {
                'titulo': para.text.strip(),
                'contenido': []
            }
            print(f"  üìù Encontrado cuento: {para.text.strip()}")
        
        else:
            # Agregar p√°rrafo al cuento actual (si no est√° vac√≠o)
            if para.text.strip():
                cuento_actual['contenido'].append(para)
    
    # Agregar el √∫ltimo cuento
    if cuento_actual['titulo'] is not None and cuento_actual['contenido']:
        cuentos.append(cuento_actual)
    
    print(f"\n‚úÖ Total de cuentos encontrados: {len(cuentos)}")
    print()
    
    # Crear un documento separado por cada cuento
    for i, cuento in enumerate(cuentos, 1):
        # Limpiar nombre de archivo (quitar caracteres no v√°lidos)
        nombre_archivo = cuento['titulo']
        for char in ['/', '\\', ':', '*', '?', '"', '<', '>', '|']:
            nombre_archivo = nombre_archivo.replace(char, '')
        
        # Limitar longitud del nombre
        if len(nombre_archivo) > 50:
            nombre_archivo = nombre_archivo[:50]
        
        ruta_salida = os.path.join(carpeta_salida, f"{nombre_archivo}.docx")
        
        # Crear nuevo documento
        nuevo_doc = Document()
        
        # Agregar t√≠tulo como Heading 3
        nuevo_doc.add_heading(cuento['titulo'], level=3)
        
        # Agregar contenido
        for para in cuento['contenido']:
            p = nuevo_doc.add_paragraph()
            p.text = para.text
            # Copiar el estilo del p√°rrafo original
            try:
                p.style = para.style
            except:
                pass
        
        # Guardar documento
        nuevo_doc.save(ruta_salida)
        print(f"{i}. ‚úÖ Creado: {nombre_archivo}.docx ({len(cuento['contenido'])} p√°rrafos)")
    
    print()
    print(f"üéâ ¬°Listo! Se crearon {len(cuentos)} archivos en '{carpeta_salida}/'")
    print()
    print("üìã Pr√≥ximos pasos:")
    print(f"   1. Verific√° los archivos en la carpeta '{carpeta_salida}/'")
    print(f"   2. Copi√° esos archivos a la carpeta 'cuentos/'")
    print("   3. Ejecut√°: python convertir_cuentos.py")
    print("   4. Sub√≠ el cuentos.json actualizado a GitHub")


if __name__ == '__main__':
    archivo = 'mf.docx'
    
    if not os.path.exists(archivo):
        print(f"‚ùå Error: No se encontr√≥ el archivo '{archivo}'")
        print(f"   Asegurate de que est√© en la misma carpeta que este script")
        exit(1)
    
    print("=" * 60)
    print("  DIVIDIR CUENTOS POR HEADING 3")
    print("=" * 60)
    print()
    
    dividir_cuentos_por_heading3(archivo)